(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[331],{9202:function(e,t,r){Promise.resolve().then(r.bind(r,5527))},5527:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return x},dynamic:function(){return g},revalidate:function(){return p}});var o=r(7437),i=r(6463),n=r(2265),s=r(5040),a=r(6264),l=r(6011),d=r(349),c=r(495),u=r(3102),f=r(2092),m=r(2365),h=r(994),v=r(4834);let g="force-dynamic",p=0,b=(0,s.ZP)("http://localhost:8000",{autoConnect:!0});function y(e){return e?e.startsWith("http")?e:"".concat("http://localhost:8000").concat(e.startsWith("/")?e:"/".concat(e)):""}function x(){let[e,t]=(0,n.useState)(null),[r,s]=(0,n.useState)(null),[g,p]=(0,n.useState)([]),[x,w]=(0,n.useState)(""),[j,S]=(0,n.useState)(!1),[k,E]=(0,n.useState)(!1),[_,N]=(0,n.useState)(null),T=(0,n.useRef)(null),U=(0,n.useRef)(null),I=(0,i.useRouter)(),C=(0,n.useMemo)(()=>localStorage.getItem("token")||"",[]);console.log(y()),(0,n.useEffect)(()=>{(async()=>{try{let e=await a.BG.me(C);console.log(e),t(e),localStorage.setItem("userId",e._id),console.log(e)}catch(e){console.error("userApi.me error",e),I.push("/login")}})()},[C]),(0,n.useEffect)(()=>{if(!(null==e?void 0:e._id))return;b.emit("join",e._id);let t=t=>{t.sender!==e._id&&(p(e=>e.some(e=>e._id===t._id)?e:[...e,t]),t.sender!==e._id?s(t.sender):t.receiver!==e._id&&s(t.receiver))};return b.on("receiveMessage",t),()=>{b.off("receiveMessage",t)}},[e,r]),(0,n.useEffect)(()=>{(null==e?void 0:e._id)&&(async()=>{try{let t=await a.xU.getConversation(e._id,C);console.log(t);let o=t.map(e=>({...e,sender:"object"==typeof e.sender?e.sender._id:e.sender,receiver:"object"==typeof e.receiver?e.receiver._id:e.receiver,fileUrl:y(e.fileUrl)}));if(p(o),!r){let t=null,r=o.find(t=>t.sender!==e._id||t.receiver!==e._id);r&&(t=r.sender!==e._id?r.sender:r.receiver),t||(t="68bd7d05bcffcf5a4f72f6c7"),t&&(s(t),localStorage.setItem("adminId",t))}}catch(e){console.error("getConversation error",e)}})()},[e,r]),(0,n.useEffect)(()=>{var e;null===(e=T.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[g]);let O=async()=>{if(!(null==e?void 0:e._id)||!x.trim())return;let t=r||"68bd7d05bcffcf5a4f72f6c7";if(t)try{let r=await a.xU.sendMessage({to:t,message:x.trim(),type:"text"},{token:C,senderId:e._id});p(o=>[...o,{...r,sender:e._id,receiver:t,fileUrl:y(r.fileUrl)}]),w(""),S(!1)}catch(e){console.error("sendMessage error",e)}},P=async t=>{if(r){E(!0);try{let o=new FormData;o.append("file",t);let{fileUrl:i}=await a.xU.upload(o,C),n=t.type.startsWith("audio")?"audio":"image";if(!e)return;let s=await a.xU.sendMessage({to:r,fileUrl:i,type:n},{token:C,senderId:e._id});p(t=>t.some(e=>e._id===s._id)?t:[...t,{...s,sender:e._id,receiver:r,fileUrl:y(s.fileUrl)}]),N(null)}catch(e){console.error("upload/send error",e)}finally{E(!1)}}},R=async()=>{if(!(null==_?void 0:_.blob))return;let e=new File([_.blob],"voice.webm",{type:"audio/webm"});await P(e)};return(0,o.jsx)("div",{className:"h-[calc(100vh-2rem)] p-3",children:(0,o.jsxs)("div",{className:"h-full rounded-2xl border border-white/10 bg-white/5 backdrop-blur flex flex-col",children:[(0,o.jsxs)("div",{className:"p-3 border-b border-white/10",children:[(0,o.jsx)("div",{className:"font-semibold",children:"(Admin) Ready to hear from you!!!"}),(0,o.jsx)("div",{className:"text-xs opacity-70",children:e?"Signed in as ".concat(e.name):"Loading…"})]}),(0,o.jsxs)("div",{className:"flex-1 overflow-y-auto p-3 h-0",children:[g.map((t,r)=>(0,o.jsx)(l.Z,{msg:t,me:(null==e?void 0:e._id)||""},"".concat(t._id||"local","-").concat(t.createdAt||Date.now(),"-").concat(r))),(0,o.jsx)("div",{ref:T})]}),(0,o.jsxs)("div",{className:"p-3 border-t border-white/10",children:[_&&(0,o.jsxs)("div",{className:"mb-2 flex items-center gap-3 rounded-xl border border-white/10 p-2 bg-white/5",children:["image"===_.kind?(0,o.jsx)("img",{src:_.url,alt:"uploaded-file",className:"max-h-32 rounded-lg object-contain"}):(0,o.jsx)("audio",{src:_.url,controls:!0,className:"w-64"}),(0,o.jsxs)("div",{className:"ml-auto flex gap-2",children:[(0,o.jsx)(c.z,{onClick:()=>N(null),variant:"ghost",className:"border border-white/10",children:"Discard"}),"audio"===_.kind?(0,o.jsx)(c.z,{onClick:R,disabled:k,children:k?"Sending…":"Send"}):(0,o.jsx)(c.z,{onClick:async()=>{let e=await fetch(_.url),t=await e.blob(),r=t.type.split("/")[1]||"png",o=new File([t],"image.".concat(r),{type:t.type});await P(o)},disabled:k,children:k?"Sending…":"Send"})]})]}),(0,o.jsxs)("div",{className:"flex items-center gap-2",children:[(0,o.jsx)(c.z,{size:"icon",variant:"ghost",onClick:()=>S(e=>!e),title:"Emoji",children:(0,o.jsx)(f.Z,{size:18})}),(0,o.jsx)(d.Z,{onStop:e=>{N({url:URL.createObjectURL(e),kind:"audio",blob:e})}}),(0,o.jsx)("input",{ref:U,type:"file",accept:"image/*,audio/*","data-testid":"chat-file-input",className:"hidden",onChange:e=>{var t;let r=null===(t=e.target.files)||void 0===t?void 0:t[0];r&&(r.type.startsWith("audio")?N({url:URL.createObjectURL(r),kind:"audio",blob:r}):N({url:URL.createObjectURL(r),kind:"image"}),e.currentTarget.value="")}}),(0,o.jsx)(c.z,{size:"icon",variant:"ghost",onClick:()=>{var e;return null===(e=U.current)||void 0===e?void 0:e.click()},title:"Attach",children:(0,o.jsx)(m.Z,{size:18})}),(0,o.jsx)(u.I,{placeholder:"Type a message",value:x,onChange:e=>w(e.target.value),onKeyDown:e=>"Enter"===e.key&&O(),className:"flex-1 bg-white/10 text-white placeholder:text-white/60 border-white/20"}),(0,o.jsxs)(c.z,{onClick:O,disabled:!x.trim(),children:[(0,o.jsx)(h.Z,{size:16,className:"mr-1"}),"Send"]})]}),j&&(0,o.jsx)("div",{className:"mt-2",children:(0,o.jsx)(v.ZP,{onEmojiClick:e=>w(t=>t+e.emoji)})})]})]})})}},6011:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});var o=r(7437),i=r(2265);function n(e){var t;let{msg:r,me:n}=e,[s,a]=(0,i.useState)(!1),l=r.sender===n,d=new Date(r.createdAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),c=(null===(t=r.fileUrl)||void 0===t?void 0:t.startsWith("http"))?r.fileUrl:"".concat("http://localhost:8000").concat(r.fileUrl);return console.log(c),(0,i.useEffect)(()=>{let e=e=>{"Escape"===e.key&&a(!1)};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]),(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{className:"my-2 flex ".concat(l?"justify-end":"justify-start"),children:(0,o.jsxs)("div",{className:"max-w-[75%]",children:[(0,o.jsx)("div",{className:"px-3 py-2 rounded-2xl shadow-md text-sm ".concat(l?"bg-blue-600 text-white rounded-br-none":"bg-[#24344d] text-gray-100 rounded-bl-none"),children:"image"===r.type?(0,o.jsx)("img",{src:c,alt:"sent",className:"rounded-lg max-h-64 object-cover cursor-pointer",onClick:()=>a(!0)}):"audio"===r.type?(0,o.jsx)("audio",{src:c,controls:!0,className:"w-56"}):(0,o.jsx)("span",{children:r.message})}),(0,o.jsx)("div",{className:"text-[10px] mt-1 ".concat(l?"text-right":"text-left"," text-gray-400"),children:d})]})}),s&&(0,o.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50",onClick:()=>a(!1),children:(0,o.jsx)("img",{src:c,alt:"preview",className:"max-h-[90vh] max-w-[90vw] object-contain rounded-lg"})})]})}},349:function(e,t,r){"use strict";r.d(t,{Z:function(){return n}});var o=r(7437),i=r(2265);function n(e){let{onStop:t}=e,r=(0,i.useRef)(null),n=(0,i.useRef)([]),[s,a]=(0,i.useState)(!1);(0,i.useEffect)(()=>()=>{r.current&&"inactive"!==r.current.state&&(r.current.stop(),r.current.stream.getTracks().forEach(e=>e.stop()))},[]);let l=async()=>{let e=await navigator.mediaDevices.getUserMedia({audio:!0}),o=MediaRecorder.isTypeSupported("audio/webm;codecs=opus")?"audio/webm;codecs=opus":MediaRecorder.isTypeSupported("audio/ogg;codecs=opus")?"audio/ogg;codecs=opus":"audio/webm",i=new MediaRecorder(e,{mimeType:o});r.current=i,n.current=[],i.ondataavailable=e=>{e.data.size>0&&n.current.push(e.data)},i.onstop=()=>{t(new Blob(n.current,{type:o})),e.getTracks().forEach(e=>e.stop())},i.start(),a(!0)};return(0,o.jsx)("button",{onClick:s?()=>{var e;null===(e=r.current)||void 0===e||e.stop(),a(!1)}:l,className:"px-3 py-2 rounded-full text-sm ".concat(s?"bg-red-600":"bg-blue-600"),title:s?"Stop":"Record voice",children:s?"■ Stop":"● Voice"})}},495:function(e,t,r){"use strict";r.d(t,{z:function(){return d}});var o=r(7437),i=r(2265),n=r(2974),s=r(3027),a=r(7440);let l=(0,s.j)("inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 ring-offset-background",{variants:{variant:{default:"bg-primary text-primary-foreground hover:bg-primary/90",destructive:"bg-destructive text-destructive-foreground hover:bg-destructive/90",outline:"border border-input bg-background hover:bg-accent hover:text-accent-foreground",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/80",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"h-10 px-4 py-2",sm:"h-9 rounded-md px-3",lg:"h-11 rounded-md px-8",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),d=i.forwardRef((e,t)=>{let{className:r,variant:i,size:s,asChild:d=!1,...c}=e,u=d?n.g7:"button";return(0,o.jsx)(u,{className:(0,a.cn)(l({variant:i,size:s,className:r})),ref:t,...c})});d.displayName="Button"},3102:function(e,t,r){"use strict";r.d(t,{I:function(){return s}});var o=r(7437),i=r(2265),n=r(7440);let s=i.forwardRef((e,t)=>{let{className:r,type:i,...s}=e;return(0,o.jsx)("input",{type:i,className:(0,n.cn)("flex h-10 w-full rounded-md border border-input bg-transparent px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",r),ref:t,...s})});s.displayName="Input"},6264:function(e,t,r){"use strict";r.d(t,{BG:function(){return a},Nq:function(){return c},iJ:function(){return d},xU:function(){return l}});let o="http://localhost:8000/api";function i(){return{adminId:localStorage.getItem("adminId")||"",userId:localStorage.getItem("userId")||""}}async function n(e){if(204===e.status)return null;let t=await e.text();if(!t)return null;try{return JSON.parse(t)}catch(e){return t}}async function s(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!o)throw Error("Missing NEXT_PUBLIC_API_URL");let r=t.body instanceof FormData,i=r?{}:{"Content-Type":"application/json"},s=t.token||localStorage.getItem("token")||"";s&&(i.Authorization="Bearer ".concat(s));let a=await fetch("".concat(o).concat(e),{method:t.method||"GET",headers:i,body:t.body?r?t.body:JSON.stringify(t.body):void 0});if(!a.ok){let e="Request failed: ".concat(a.status);try{let t=await a.json();(null==t?void 0:t.message)?e=t.message:"string"==typeof t&&(e=t)}catch(t){try{let t=await a.text();t&&(e=t)}catch(e){}}throw Error(e)}return await n(a)}let a={me:e=>s("/users/profile",{method:"GET",token:e}),getById:(e,t)=>s("/users/".concat(e),{method:"GET",token:t}),search:(e,t)=>s("/users/search?q=".concat(encodeURIComponent(e)),{method:"GET",token:t}),changePassword:e=>s("/users/password/change",{method:"POST",body:e}),requestPasswordOtp:()=>s("/users/password/request-otp",{method:"POST"}),resetPasswordWithOtp:e=>s("/users/password/reset-otp",{method:"POST",body:e}),updateProfile:(e,t)=>s("/users/profile",{method:"PUT",body:e,token:t}),stats:e=>s("/users/me/stats",{method:"GET",token:e}),unread:e=>s("/users/messages/unread",{method:"GET",token:e})},l={getConversation:(e,t)=>s("/chat/".concat(e),{method:"GET",token:t}),sendMessage:(e,t)=>{let{adminId:r,userId:o}=i(),n=(null==t?void 0:t.senderId)||r||o||"";if(console.log("\uD83D\uDCE4 Sending message:",{sender:n,receiver:e.to,message:e.message,fileUrl:e.fileUrl,type:e.type}),!e.to)throw Error("Receiver ID (data.to) is missing!");return s("/chat/send",{method:"POST",body:{sender:n,receiver:e.to,message:e.message||"",fileUrl:e.fileUrl||"",type:e.type||"text"},token:null==t?void 0:t.token})},upload:async(e,t)=>{let r=await s("/chat/upload",{method:"POST",body:e,token:t}),o=(null==r?void 0:r.fileUrl)||(null==r?void 0:r.url)||"";if(!o)throw Error("Upload failed: missing fileUrl");return{fileUrl:o}},removeUser:(e,t)=>s("/chat/remove/".concat(e),{method:"DELETE",token:t}),getConversations:async e=>{let{userId:t}=i();if(!t)return[];let r=await s("/chat/".concat(t),{method:"GET",token:e});if(!Array.isArray(r)||0===r.length)return[];let o=r[r.length-1],n=(null==o?void 0:o.message)||((null==o?void 0:o.type)==="image"?"[Image]":(null==o?void 0:o.type)==="audio"?"[Audio]":(null==o?void 0:o.type)==="emoji"?"[Emoji]":"");return[{_id:(null==o?void 0:o._id)||"conv-".concat(t),userId:t,lastMessage:n||"",updatedAt:(null==o?void 0:o.createdAt)||new Date().toISOString()}]}},d={register:e=>s("/auth/register",{method:"POST",body:e}),verifyOtp:e=>s("/auth/verify-otp",{method:"POST",body:e}),login:async e=>{var t,r,o,i,n,a;let l=await s("/auth/login",{method:"POST",body:e}),d=(null==l?void 0:l.token)||(null==l?void 0:l.accessToken)||"",c={_id:(null==l?void 0:l._id)||(null==l?void 0:null===(t=l.user)||void 0===t?void 0:t._id)||"",name:(null==l?void 0:l.name)||(null==l?void 0:null===(r=l.user)||void 0===r?void 0:r.name)||"",email:(null==l?void 0:l.email)||(null==l?void 0:null===(o=l.user)||void 0===o?void 0:o.email)||"",photo:(null==l?void 0:l.photo)||(null==l?void 0:null===(i=l.user)||void 0===i?void 0:i.photo)||void 0,role:(null==l?void 0:l.role)||(null==l?void 0:null===(n=l.user)||void 0===n?void 0:n.role)||void 0,createdAt:(null==l?void 0:l.createdAt)||(null==l?void 0:null===(a=l.user)||void 0===a?void 0:a.createdAt)||void 0};if(!d||!c._id)throw Error("Invalid login response from server");return{token:d,user:c}},forgotPassword:e=>s("/auth/forgot-password",{method:"POST",body:e}),resetPassword:(e,t)=>s("/auth/reset-password",{method:"POST",body:e,token:t}),resendOtp:e=>s("/auth/resend-otp",{method:"POST",body:e})},c={stats:e=>s("/admin/stats",{method:"GET",token:e}),usersList:e=>s("/admin/users/list",{method:"GET",token:e}),usersAll:e=>s("/admin/users/all",{method:"GET",token:e})}},7440:function(e,t,r){"use strict";r.d(t,{cn:function(){return n}});var o=r(4839),i=r(6164);function n(){for(var e=arguments.length,t=Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,i.m6)((0,o.W)(t))}}},function(e){e.O(0,[560,492,971,23,744],function(){return e(e.s=9202)}),_N_E=e.O()}]);